<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="keyword" content="抢票系统"/>
    <meta name="description" content="易班——抢票"/>
    <link rel="short icon" type="image/x-icon" href="/img/logo.ico"/>
    <title>抢票系统——后台管理</title>

    <link rel="stylesheet" href=/css/bootstrap.css"/>
    <link rel="stylesheet" media="screen" href="/css/bootstrap-datetimepicker.min.css">
    <link rel="stylesheet" href="/font-awesome-4.7.0/css/font-awesome.css">
    <link type="text/css" rel="stylesheet" href="/css/common.css"/>
    <link rel="stylesheet" href="/css/back_stage_view.css"/>
    <style>
        .btnExport{
            margin-bottom:20px;
        }
    </style>
</head>
<body>
    <header>
        <h1 class="text-center">易抢票—座位管理</h1>
    </header>
    <hr/>
    <main>
        <div id="container">
            <table id="backViewTable" class="table table-hover table-sm table2excel">
                <thead>
                <tr>
                    <th>#</th>
                    <th>易班ID</th>
                    <th>姓名</th>
                    <th>座位号</th>
                    <th>操作</th>
                </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>

        <button class="btn btn-primary btn-sm btnView">一键查看</button>
        <button class="btn btn-primary btn-sm btnExport" onclick="tablesToExcel(['backViewTable'], ['ProductDay1'], 'backViewTable.xls', 'Excel')">一键导出</button>
    </main>
<script src="/js/jquery-3.1.1.min.js"></script>
<script src="/js/bootstrap.js"></script>
<script>
    window.onload=function(){
        var oBackViewTable=document.getElementById('container');
        var oBtnView=document.getElementsByClassName('btnView')[0];
        var oBtnExport=document.getElementsByClassName('btnExport')[0];
        oBackViewTable.style.display='none';
        oBtnExport.style.display='none';
        //解析座位号
        var numArrSeatInfo=[];
        var location='';
        var seatInfo;
        function seatParse(s){
            seatInfo='';
            var arrSeatInfo=s.split('_');
            numArrSeatInfo=arrSeatInfo.map(function(item,index,array){
                return Number(item);
            });
            if(numArrSeatInfo[0]===1){
                location='图书馆报告厅';
            }else if(numArrSeatInfo[0]===2){
                location='思学楼A114';
            }else if(numArrSeatInfo[0]===3){
                location='艺术大楼演播厅';
            }
            seatInfo+=location+numArrSeatInfo[1]+'楼'+numArrSeatInfo[2]+'排'+numArrSeatInfo[3]+'座';
            return seatInfo;
        }

        var $oBtnView=$(oBtnView);
        var $oBtnExport=$(oBtnExport);
        var $oBackViewTable=$(oBackViewTable);
        var $tbodyHtml='';
        $oBtnView.click(function(){
            $.ajax({
                type:'GET',
                url:'http://www.deardull.com:8080/getAllSeatsForManage',
                dataType:'jsonp',
                jsonp:'callback',
                success:function(data){
                    $oBtnView.css('display','none');
                    $.each(data,function(index,indexInfo){
                        $tbodyHtml+='<tr><th scope="row">'+(index+1)+'</th><td>'+data[index].yiban_id+'</td><td>'+data[index].name+'</td><td>'+seatParse(data[index].seat_num)+'</td><td><form method="post" action="/deleteSeat"> <input type="hidden" name="yiban_id" value='+Number(data[index].yiban_id)+'/> <input class="btn-primary" type="submit" value="删除"/> </form></tr>';
                    });
                    $('tbody').html($tbodyHtml);
                    $oBackViewTable.css('display','block');
                    $oBtnExport.css('display','block');
                }
            })
        })
//不能如下调用，加载页面时直接下载Excel
//      oBtnExport.onclick=tablesToExcel(['backViewTable'], ['ProductDay1'], 'TestBook.xls', 'Excel');
    };
    //导出Excel函数
    var tablesToExcel = (function() {
        var uri = 'data:application/vnd.ms-excel;base64,'
            , tmplWorkbookXML = '<?xml version="1.0"?><?mso-application progid="Excel.Sheet"?><Workbook xmlns="urn:schemas-microsoft-com:office:spreadsheet" xmlns:ss="urn:schemas-microsoft-com:office:spreadsheet">'
            + '<DocumentProperties xmlns="urn:schemas-microsoft-com:office:office"><Author>Axel Richter</Author><Created>{created}</Created></DocumentProperties>'
            + '<Styles>'
            + '<Style ss:ID="Currency"><NumberFormat ss:Format="Currency"></NumberFormat></Style>'
            + '<Style ss:ID="Date"><NumberFormat ss:Format="Medium Date"></NumberFormat></Style>'
            + '</Styles>'
            + '{worksheets}</Workbook>'
            , tmplWorksheetXML = '<Worksheet ss:Name="{nameWS}"><Table>{rows}</Table></Worksheet>'
            , tmplCellXML = '<Cell{attributeStyleID}{attributeFormula}><Data ss:Type="{nameType}">{data}</Data></Cell>'
            , base64 = function(s) { return window.btoa(unescape(encodeURIComponent(s))) }
            , format = function(s, c) { return s.replace(/{(\w+)}/g, function(m, p) { return c[p]; }) }
        return function(tables, wsnames, wbname, appname) {
            var ctx = "";
            var workbookXML = "";
            var worksheetsXML = "";
            var rowsXML = "";

            for (var i = 0; i < tables.length; i++) {
                if (!tables[i].nodeType) tables[i] = document.getElementById(tables[i]);
                for (var j = 0; j < tables[i].rows.length; j++) {
                    rowsXML += '<Row>'
                    for (var k = 0; k < tables[i].rows[j].cells.length-1; k++) {
                        var dataType = tables[i].rows[j].cells[k].getAttribute("data-type");
                        var dataStyle = tables[i].rows[j].cells[k].getAttribute("data-style");
                        var dataValue = tables[i].rows[j].cells[k].getAttribute("data-value");
                        dataValue = (dataValue)?dataValue:tables[i].rows[j].cells[k].innerHTML;
                        var dataFormula = tables[i].rows[j].cells[k].getAttribute("data-formula");
                        dataFormula = (dataFormula)?dataFormula:(appname=='Calc' && dataType=='DateTime')?dataValue:null;
                        ctx = {  attributeStyleID: (dataStyle=='Currency' || dataStyle=='Date')?' ss:StyleID="'+dataStyle+'"':''
                            , nameType: (dataType=='Number' || dataType=='DateTime' || dataType=='Boolean' || dataType=='Error')?dataType:'String'
                            , data: (dataFormula)?'':dataValue
                            , attributeFormula: (dataFormula)?' ss:Formula="'+dataFormula+'"':''
                        };
                        rowsXML += format(tmplCellXML, ctx);
                    }
                    rowsXML += '</Row>'
                }
                ctx = {rows: rowsXML, nameWS: wsnames[i] || 'Sheet' + i};
                worksheetsXML += format(tmplWorksheetXML, ctx);
                rowsXML = "";
            }

            ctx = {created: (new Date()).getTime(), worksheets: worksheetsXML};
            workbookXML = format(tmplWorkbookXML, ctx);

            console.log(workbookXML);

            var link = document.createElement("A");
            link.href = uri + base64(workbookXML);
            link.download = wbname || 'Workbook.xls';
            link.target = '_blank';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    })();

</script>
</body>
</html>